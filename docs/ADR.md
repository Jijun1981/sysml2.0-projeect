# 架构决策记录 (ADR)

## ADR-001: GraphQL作为统一API层
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 使用GraphQL替代REST API  
**原因**: 
- 避免过度获取/获取不足
- 类型安全的契约
- 支持实时订阅  
**影响**: 所有领域通过GraphQL Schema暴露能力

## ADR-002: Lean CDO配置
**日期**: 2024-01  
**状态**: Accepted  
**决策**: CDO采用单Repository、无分支、无审计的精简配置  
**原因**:
- 降低复杂度
- 提高性能
- 简化事务管理  
**代价**: 失去版本历史和分支能力  
**缓解**: 通过应用层审计字段补偿

## ADR-003: MECE领域划分
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 严格执行MECE原则划分领域边界  
**具体划分**:
- REQ: 仅需求自身和需求间关系
- STRUCT: 仅拓扑规则，不含数值约束
- TRACE: 所有跨域关系，只读消费  
**原因**: 防止循环依赖，保证可维护性  
**验证**: 架构测试自动检查依赖环

## ADR-004: Payload统一返回模式
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 所有GraphQL Mutation返回Payload类型  
**格式**: `{ ok: Boolean!, error: Error, item: T }`  
**原因**:
- 统一错误处理
- 便于前端处理
- 支持部分成功场景  
**影响**: 需要生成大量Payload类型

## ADR-005: 约束结果独立存储
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 约束计算结果存储在独立表，不回写源对象  
**原因**:
- 避免循环依赖
- 保留计算历史
- 支持provenance追踪  
**实现**: constraint_results表，包含sourceId但不建外键

## ADR-006: 生产环境关闭Introspection
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 生产环境默认关闭GraphQL introspection  
**原因**: 安全考虑，防止schema泄露  
**例外**: 管理员权限可临时开启  
**实现**: 通过Spring Profile控制

## ADR-007: 同步计算优先策略
**日期**: 2024-01  
**状态**: Accepted  
**决策**: P3阶段约束计算采用同步执行+超时保护  
**原因**:
- 降低初期复杂度
- 便于调试
- 可预测的行为  
**演进**: P4/P5引入异步队列  
**超时**: 默认5秒

## ADR-008: M2模型版本锁定
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 锁定sysml-v2-pilot特定版本  
**原因**: 
- 保证稳定性
- 避免破坏性变更  
**策略**: 季度评估升级，充分测试  
**回滚**: 保留前一版本3个月

## ADR-009: 性能基准三档定义
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 定义Small/Medium/Large三档数据集  
**具体**:
- Small: 100元素, P50<100ms
- Medium: 1000元素, P50<200ms  
- Large: 10000元素, P50<500ms  
**用途**: CI性能门禁，回归测试

## ADR-010: 最小文档集
**日期**: 2024-01  
**状态**: Accepted  
**决策**: 只维护5个核心文档  
**文档列表**:
1. ARCHITECTURE.md - 架构设计
2. REQUIREMENTS.yaml - 需求追踪
3. API_CONTRACT.graphqls - API契约
4. ADR.md - 决策记录
5. README.md - 快速启动  
**原则**: 代码即文档，契约即文档