<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Sirius调用M2模型演示</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .complexity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .simple { background: #4CAF50; color: white; }
        .medium { background: #FF9800; color: white; }
        .complex { background: #f44336; color: white; }
        .code-block {
            background: #f4f4f4;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .button:hover {
            background: #45a049;
        }
        .result {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }
        .flow-step {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: #fff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            margin: 0 10px;
        }
        .arrow {
            font-size: 24px;
            color: #4CAF50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sirius如何调用M2（元）模型 <span class="complexity-badge medium">中等复杂度</span></h1>
        
        <div class="section">
            <h2>📊 架构概览</h2>
            <div class="flow-diagram">
                <div class="flow-step">
                    <h3>Sirius UI</h3>
                    <p>图形化建模工具</p>
                </div>
                <span class="arrow">→</span>
                <div class="flow-step">
                    <h3>M2元模型</h3>
                    <p>KerML/SysML定义</p>
                </div>
                <span class="arrow">→</span>
                <div class="flow-step">
                    <h3>EMF实例</h3>
                    <p>模型对象</p>
                </div>
                <span class="arrow">→</span>
                <div class="flow-step">
                    <h3>CDO存储</h3>
                    <p>持久化</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🔍 M2模型信息</h2>
            <button class="button" onclick="loadM2Info()">查看已加载的M2模型</button>
            <div id="m2Info" class="result"></div>
        </div>

        <div class="section">
            <h2>⚙️ 使用M2创建元素</h2>
            <p>Sirius通过以下步骤调用M2模型：</p>
            <div class="code-block">
// 1. 获取元类定义
EClass requirementClass = sysmlPackage.getEClass("Requirement");

// 2. 创建实例
EObject requirement = factory.create(requirementClass);

// 3. 设置属性
requirement.eSet(nameAttribute, "Safety Requirement");

// 4. 保存到CDO
cdoResource.getContents().add(requirement);
            </div>
            
            <h3>试试创建一个元素：</h3>
            <select id="metaclass">
                <option value="Requirement">需求 (Requirement)</option>
                <option value="Part">部件 (Part)</option>
                <option value="Port">端口 (Port)</option>
            </select>
            <input type="text" id="elementName" placeholder="元素名称" value="TestElement">
            <button class="button" onclick="createElement()">创建元素</button>
            <div id="createResult" class="result"></div>
        </div>

        <div class="section">
            <h2>📈 复杂度分析</h2>
            <table>
                <tr>
                    <th>层级</th>
                    <th>任务</th>
                    <th>复杂度</th>
                    <th>说明</th>
                </tr>
                <tr>
                    <td>基础</td>
                    <td>使用EMF API</td>
                    <td><span class="complexity-badge simple">简单</span></td>
                    <td>直接调用EFactory创建实例</td>
                </tr>
                <tr>
                    <td>中级</td>
                    <td>理解元模型约束</td>
                    <td><span class="complexity-badge medium">中等</span></td>
                    <td>需要理解SysML语义和约束规则</td>
                </tr>
                <tr>
                    <td>高级</td>
                    <td>完整集成</td>
                    <td><span class="complexity-badge complex">复杂</span></td>
                    <td>包括验证、转换、CDO事务、并发控制</td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h2>🎯 Sirius具体使用方式</h2>
            <button class="button" onclick="showSiriusUsage()">查看Sirius集成细节</button>
            <div id="siriusUsage" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/sirius/m2';
        
        async function loadM2Info() {
            try {
                const response = await fetch(`${API_BASE}/info`);
                const data = await response.json();
                
                let html = '<h3>已加载的M2元模型：</h3>';
                html += '<ul>';
                if (data.availableModels && data.availableModels.length > 0) {
                    data.availableModels.forEach(model => {
                        html += `<li><strong>${model.name}</strong> - ${model.classCount}个元类 (${model.uri})</li>`;
                    });
                } else {
                    html += '<li>KerML核心包 (Element, Relationship, Feature, Class)</li>';
                    html += '<li>SysML需求包 (Requirement, DeriveReqt, Satisfy)</li>';
                    html += '<li>SysML结构包 (Part, Port, Connection, Interface)</li>';
                }
                html += '</ul>';
                
                if (data.complexity) {
                    html += '<h3>复杂度说明：</h3>';
                    html += '<ul>';
                    Object.entries(data.complexity).forEach(([level, desc]) => {
                        html += `<li><strong>${level}:</strong> ${desc}</li>`;
                    });
                    html += '</ul>';
                }
                
                document.getElementById('m2Info').innerHTML = html;
                document.getElementById('m2Info').style.display = 'block';
            } catch (error) {
                document.getElementById('m2Info').innerHTML = 
                    '<p style="color: red;">错误：' + error.message + '</p>';
                document.getElementById('m2Info').style.display = 'block';
            }
        }
        
        async function createElement() {
            const metaclass = document.getElementById('metaclass').value;
            const name = document.getElementById('elementName').value;
            
            try {
                const response = await fetch(`${API_BASE}/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({metaclass, name})
                });
                const data = await response.json();
                
                let html = '';
                if (data.success) {
                    html = '<h3>✅ 成功创建元素</h3>';
                    if (data.instance) {
                        html += `<p><strong>类型：</strong>${data.instance.class}</p>`;
                        html += `<p><strong>包：</strong>${data.instance.package}</p>`;
                        if (data.instance.attributes) {
                            html += '<p><strong>属性：</strong></p><ul>';
                            Object.entries(data.instance.attributes).forEach(([key, value]) => {
                                html += `<li>${key}: ${value}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                    html += `<p><em>${data.complexity || '这演示了Sirius如何通过M2创建模型元素'}</em></p>`;
                } else {
                    html = `<h3>❌ 创建失败</h3><p>${data.error}</p>`;
                }
                
                document.getElementById('createResult').innerHTML = html;
                document.getElementById('createResult').style.display = 'block';
            } catch (error) {
                // 模拟成功（如果后端未运行）
                const mockHtml = `
                    <h3>✅ 模拟创建成功</h3>
                    <p><strong>元类：</strong>${metaclass}</p>
                    <p><strong>名称：</strong>${name}</p>
                    <p><strong>过程：</strong></p>
                    <ol>
                        <li>Sirius查找M2中的${metaclass}元类</li>
                        <li>使用EMF Factory创建实例</li>
                        <li>设置name属性为"${name}"</li>
                        <li>应用SysML语义规则</li>
                        <li>保存到CDO Repository</li>
                    </ol>
                `;
                document.getElementById('createResult').innerHTML = mockHtml;
                document.getElementById('createResult').style.display = 'block';
            }
        }
        
        async function showSiriusUsage() {
            try {
                const response = await fetch(`${API_BASE}/sirius-usage`);
                const data = await response.json();
                
                let html = '<h3>Sirius使用M2的方式：</h3>';
                Object.entries(data).forEach(([key, value]) => {
                    if (typeof value === 'object') {
                        html += `<h4>${value.description || key}</h4>`;
                        if (value.process) {
                            html += '<ol>';
                            value.process.forEach(step => {
                                html += `<li>${step}</li>`;
                            });
                            html += '</ol>';
                        }
                        if (value.examples) {
                            html += '<ul>';
                            value.examples.forEach(ex => {
                                html += `<li>${ex}</li>`;
                            });
                            html += '</ul>';
                        }
                    }
                });
                
                document.getElementById('siriusUsage').innerHTML = html;
                document.getElementById('siriusUsage').style.display = 'block';
            } catch (error) {
                // 模拟数据
                const mockHtml = `
                    <h3>Sirius使用M2的实际方式：</h3>
                    <h4>1. 视图定义（.odesign文件）</h4>
                    <div class="code-block">
&lt;node name="RequirementNode" domainClass="sysml::Requirement"&gt;
    &lt;style&gt;...&lt;/style&gt;
    &lt;conditionalStyles&gt;...&lt;/conditionalStyles&gt;
&lt;/node&gt;
                    </div>
                    <h4>2. 工具调用流程</h4>
                    <ol>
                        <li>用户在画布上点击"创建需求"工具</li>
                        <li>Sirius查找sysml::Requirement元类</li>
                        <li>调用EFactory.create()创建实例</li>
                        <li>执行工具中定义的初始化操作</li>
                        <li>通过CDO Transaction提交</li>
                    </ol>
                    <h4>3. 验证规则</h4>
                    <ul>
                        <li>基于M2的多重性约束</li>
                        <li>类型兼容性检查</li>
                        <li>必填属性验证</li>
                    </ul>
                `;
                document.getElementById('siriusUsage').innerHTML = mockHtml;
                document.getElementById('siriusUsage').style.display = 'block';
            }
        }
    </script>
</body>
</html>