<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysML Requirements Canvas - Sirius Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toolbar {
            background: white;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tool-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tool-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .tool-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
        }
        .palette {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .palette-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .palette-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .palette-item.dragging {
            opacity: 0.5;
        }
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #fafafa;
            background-image: 
                linear-gradient(rgba(200,200,200,0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200,200,200,0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #canvas {
            position: relative;
            width: 2000px;
            height: 2000px;
        }
        .node {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            min-width: 180px;
            cursor: move;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .node:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        .node.selected {
            border-color: #764ba2;
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        }
        .node-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .node-type {
            font-size: 0.9em;
            color: #666;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .node-content {
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        .node.requirement-def {
            border-color: #4CAF50;
        }
        .node.requirement-usage {
            border-color: #2196F3;
        }
        .connection-line {
            stroke: #667eea;
            stroke-width: 2;
            fill: none;
            pointer-events: stroke;
            cursor: pointer;
        }
        .connection-line:hover {
            stroke-width: 3;
            stroke: #764ba2;
        }
        .arrow-marker {
            fill: #667eea;
        }
        .properties-panel {
            width: 300px;
            background: white;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }
        .properties-panel h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .property-group {
            margin-bottom: 20px;
        }
        .property-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .property-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .property-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        svg * {
            pointer-events: auto;
        }
        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 5px 20px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>üìã</span>
            SysML Requirements Canvas
        </h1>
        <div>
            <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px;">
                Powered by Sirius Web 2025.8.0
            </span>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="setMode('select')">
            <span>üëÜ</span> Select
        </button>
        <button class="tool-btn" onclick="setMode('connect')">
            <span>üîó</span> Connect
        </button>
        <button class="tool-btn" onclick="deleteSelected()">
            <span>üóëÔ∏è</span> Delete
        </button>
        <button class="tool-btn" onclick="autoLayout()">
            <span>üìê</span> Auto Layout
        </button>
        <button class="tool-btn" onclick="saveToGraphQL()">
            <span>üíæ</span> Save
        </button>
        <button class="tool-btn" onclick="loadFromGraphQL()">
            <span>üìÇ</span> Load
        </button>
    </div>

    <div class="workspace">
        <div class="sidebar">
            <div class="sidebar-header">üé® Palette</div>
            <div class="palette">
                <div class="palette-item" draggable="true" data-type="requirement-def">
                    <span>üì¶</span>
                    <div>
                        <div style="font-weight: bold;">Requirement Definition</div>
                        <div style="font-size: 0.8em; color: #666;">Define a requirement type</div>
                    </div>
                </div>
                <div class="palette-item" draggable="true" data-type="requirement-usage">
                    <span>üìã</span>
                    <div>
                        <div style="font-weight: bold;">Requirement Usage</div>
                        <div style="font-size: 0.8em; color: #666;">Use a requirement</div>
                    </div>
                </div>
                <div class="palette-item" draggable="true" data-type="derive">
                    <span>‚û°Ô∏è</span>
                    <div>
                        <div style="font-weight: bold;">Derive Relationship</div>
                        <div style="font-size: 0.8em; color: #666;">Create derivation</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <svg id="connections"></svg>
            <div id="canvas"></div>
        </div>

        <div class="properties-panel">
            <h3>Properties</h3>
            <div id="properties-content">
                <p style="color: #999;">Select an element to view properties</p>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-indicator"></span>
            <span>Connected to Sirius Web</span>
        </div>
        <div class="status-item">
            <span id="elementCount">0 elements</span>
        </div>
    </div>

    <script>
        let mode = 'select';
        let selectedElement = null;
        let draggedElement = null;
        let connections = [];
        let nodeIdCounter = 1;
        let connectionStart = null;

        // ËÆæÁΩÆÊ®°Âºè
        function setMode(newMode) {
            mode = newMode;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
            
            if (mode === 'connect') {
                document.getElementById('canvas').style.cursor = 'crosshair';
            } else {
                document.getElementById('canvas').style.cursor = 'default';
            }
        }

        // ÊãñÊãΩpaletteÂÖÉÁ¥†
        document.querySelectorAll('.palette-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('type', item.dataset.type);
                item.classList.add('dragging');
            });
            
            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
            });
        });

        // CanvasÊãñÊîæ
        const canvasContainer = document.getElementById('canvasContainer');
        const canvas = document.getElementById('canvas');

        canvasContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        canvasContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            if (type && type !== 'derive') {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left + canvasContainer.scrollLeft;
                const y = e.clientY - rect.top + canvasContainer.scrollTop;
                createNode(type, x, y);
            }
        });

        // ÂàõÂª∫ËäÇÁÇπ
        function createNode(type, x, y) {
            const node = document.createElement('div');
            node.className = `node ${type}`;
            node.id = `node-${nodeIdCounter++}`;
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            
            const icon = type === 'requirement-def' ? 'üì¶' : 'üìã';
            const typeName = type === 'requirement-def' ? 'RequirementDefinition' : 'RequirementUsage';
            
            node.innerHTML = `
                <div class="node-header">
                    <span>${icon}</span>
                    <span>Requirement ${nodeIdCounter - 1}</span>
                </div>
                <div class="node-type">${typeName}</div>
                <div class="node-content">
                    Enter requirement description here...
                </div>
            `;
            
            canvas.appendChild(node);
            makeNodeInteractive(node);
            updateElementCount();
        }

        // ‰ΩøËäÇÁÇπÂèØ‰∫§‰∫í
        function makeNodeInteractive(node) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            node.addEventListener('mousedown', (e) => {
                if (mode === 'select') {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = node.offsetLeft;
                    initialY = node.offsetTop;
                    selectElement(node);
                } else if (mode === 'connect') {
                    if (!connectionStart) {
                        connectionStart = node;
                        node.style.border = '3px solid #ff9800';
                    } else if (connectionStart !== node) {
                        createConnection(connectionStart, node);
                        connectionStart.style.border = '';
                        connectionStart = null;
                    }
                }
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging && mode === 'select') {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    node.style.left = (initialX + deltaX) + 'px';
                    node.style.top = (initialY + deltaY) + 'px';
                    updateConnections();
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        // ÈÄâÊã©ÂÖÉÁ¥†
        function selectElement(element) {
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            element.classList.add('selected');
            selectedElement = element;
            showProperties(element);
        }

        // ÊòæÁ§∫Â±ûÊÄß
        function showProperties(element) {
            const props = document.getElementById('properties-content');
            const header = element.querySelector('.node-header span:last-child').textContent;
            const content = element.querySelector('.node-content').textContent;
            
            props.innerHTML = `
                <div class="property-group">
                    <div class="property-label">Name</div>
                    <input class="property-input" value="${header}" onchange="updateNodeName(this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Description</div>
                    <textarea class="property-input" rows="4" onchange="updateNodeContent(this.value)">${content}</textarea>
                </div>
                <div class="property-group">
                    <div class="property-label">Type</div>
                    <input class="property-input" value="${element.classList.contains('requirement-def') ? 'RequirementDefinition' : 'RequirementUsage'}" readonly>
                </div>
                <div class="property-group">
                    <div class="property-label">ID</div>
                    <input class="property-input" value="${element.id}" readonly>
                </div>
            `;
        }

        // Êõ¥Êñ∞ËäÇÁÇπÂêçÁß∞
        function updateNodeName(value) {
            if (selectedElement) {
                selectedElement.querySelector('.node-header span:last-child').textContent = value;
            }
        }

        // Êõ¥Êñ∞ËäÇÁÇπÂÜÖÂÆπ
        function updateNodeContent(value) {
            if (selectedElement) {
                selectedElement.querySelector('.node-content').textContent = value;
            }
        }

        // ÂàõÂª∫ËøûÊé•
        function createConnection(from, to) {
            connections.push({ from: from.id, to: to.id });
            drawConnections();
        }

        // ÁªòÂà∂ÊâÄÊúâËøûÊé•
        function drawConnections() {
            const svg = document.getElementById('connections');
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" class="arrow-marker" />
                    </marker>
                </defs>
            `;
            
            connections.forEach(conn => {
                const from = document.getElementById(conn.from);
                const to = document.getElementById(conn.to);
                if (from && to) {
                    const x1 = from.offsetLeft + from.offsetWidth / 2;
                    const y1 = from.offsetTop + from.offsetHeight / 2;
                    const x2 = to.offsetLeft + to.offsetWidth / 2;
                    const y2 = to.offsetTop + to.offsetHeight / 2;
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} L ${x2} ${y2}`;
                    line.setAttribute('d', d);
                    line.setAttribute('class', 'connection-line');
                    line.setAttribute('marker-end', 'url(#arrowhead)');
                    svg.appendChild(line);
                }
            });
        }

        // Êõ¥Êñ∞ËøûÊé•
        function updateConnections() {
            drawConnections();
        }

        // Âà†Èô§ÈÄâ‰∏≠ÂÖÉÁ¥†
        function deleteSelected() {
            if (selectedElement) {
                connections = connections.filter(c => c.from !== selectedElement.id && c.to !== selectedElement.id);
                selectedElement.remove();
                selectedElement = null;
                document.getElementById('properties-content').innerHTML = '<p style="color: #999;">Select an element to view properties</p>';
                updateConnections();
                updateElementCount();
            }
        }

        // Ëá™Âä®Â∏ÉÂ±Ä
        function autoLayout() {
            const nodes = document.querySelectorAll('.node');
            let x = 50, y = 50;
            nodes.forEach((node, i) => {
                node.style.left = x + 'px';
                node.style.top = y + 'px';
                x += 250;
                if (x > 800) {
                    x = 50;
                    y += 150;
                }
            });
            updateConnections();
        }

        // Êõ¥Êñ∞ÂÖÉÁ¥†ËÆ°Êï∞
        function updateElementCount() {
            const count = document.querySelectorAll('.node').length;
            document.getElementById('elementCount').textContent = `${count} elements`;
        }

        // ‰øùÂ≠òÂà∞GraphQL
        async function saveToGraphQL() {
            const nodes = Array.from(document.querySelectorAll('.node')).map(node => ({
                id: node.id,
                type: node.classList.contains('requirement-def') ? 'RequirementDefinition' : 'RequirementUsage',
                name: node.querySelector('.node-header span:last-child').textContent,
                content: node.querySelector('.node-content').textContent,
                x: node.offsetLeft,
                y: node.offsetTop
            }));
            
            alert('Saving to Sirius Web backend...\nNodes: ' + JSON.stringify(nodes, null, 2));
            
            // ËøôÈáåÂèØ‰ª•ÂÆûÈôÖË∞ÉÁî®GraphQL API
            // const response = await fetch('/graphql', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({
            //         query: `mutation { saveRequirements(...) }`
            //     })
            // });
        }

        // ‰ªéGraphQLÂä†ËΩΩ
        async function loadFromGraphQL() {
            alert('Loading from Sirius Web backend...');
            // ÂÆûÈôÖÂÆûÁé∞Â∞Ü‰ªéGraphQLÂä†ËΩΩÊï∞ÊçÆ
        }

        // ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÂèñÊ∂àÈÄâÊã©
        canvas.addEventListener('click', (e) => {
            if (e.target === canvas) {
                document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
                selectedElement = null;
                document.getElementById('properties-content').innerHTML = '<p style="color: #999;">Select an element to view properties</p>';
            }
        });

        // ÂàùÂßãÂåñÔºöÂàõÂª∫‰∏§‰∏™Á§∫‰æãËäÇÁÇπ
        setTimeout(() => {
            createNode('requirement-def', 100, 100);
            createNode('requirement-usage', 400, 100);
        }, 100);
    </script>
</body>
</html>