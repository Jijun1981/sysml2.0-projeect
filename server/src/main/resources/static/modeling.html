<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysML v2 建模工作台 - Sirius Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        /* 顶部工具栏 */
        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toolbar h1 {
            font-size: 18px;
            margin-right: auto;
        }
        
        .toolbar button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .toolbar button:hover {
            background: #2980b9;
        }
        
        /* 主容器 */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* 左侧面板 - 组件库 */
        .palette {
            width: 250px;
            background: white;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }
        
        .palette h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .palette-item {
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
            text-align: center;
        }
        
        .palette-item:hover {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .palette-item.requirement {
            border-color: #e74c3c;
        }
        
        .palette-item.block {
            border-color: #3498db;
        }
        
        .palette-item.interface {
            border-color: #f39c12;
        }
        
        .palette-item.constraint {
            border-color: #9b59b6;
        }
        
        /* 中间画布 */
        .canvas-container {
            flex: 1;
            position: relative;
            background: white;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
        }
        
        /* 右侧属性面板 */
        .properties {
            width: 300px;
            background: white;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }
        
        .properties h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .property-group input,
        .property-group select,
        .property-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .property-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* SVG元素样式 */
        .sysml-element {
            cursor: move;
        }
        
        .sysml-element.selected {
            filter: drop-shadow(0 0 3px #3498db);
        }
        
        .connection-line {
            stroke: #34495e;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .connection-line.derive {
            stroke: #3498db;
            stroke-dasharray: 5,5;
        }
        
        .connection-line.refine {
            stroke: #e74c3c;
        }
        
        .connection-line.satisfy {
            stroke: #27ae60;
        }
        
        /* 状态栏 */
        .statusbar {
            background: #ecf0f1;
            padding: 5px 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>🚀 SysML v2 建模工作台</h1>
        <button onclick="saveModel()">💾 保存</button>
        <button onclick="loadModel()">📂 加载</button>
        <button onclick="exportSVG()">📷 导出SVG</button>
        <button onclick="clearCanvas()">🗑️ 清空</button>
        <button onclick="autoLayout()">📐 自动布局</button>
    </div>
    
    <div class="main-container">
        <!-- 左侧组件面板 -->
        <div class="palette">
            <h3>需求元素</h3>
            <div class="palette-item requirement" draggable="true" data-type="requirement">
                📋 需求 (Requirement)
            </div>
            
            <h3>结构元素</h3>
            <div class="palette-item block" draggable="true" data-type="block">
                📦 块 (Block)
            </div>
            <div class="palette-item interface" draggable="true" data-type="interface">
                🔌 接口 (Interface)
            </div>
            
            <h3>约束元素</h3>
            <div class="palette-item constraint" draggable="true" data-type="constraint">
                ⚖️ 约束 (Constraint)
            </div>
            
            <h3>关系</h3>
            <div class="palette-item" onclick="setConnectionMode('derive')">
                ↘️ 派生 (Derive)
            </div>
            <div class="palette-item" onclick="setConnectionMode('refine')">
                🔄 细化 (Refine)
            </div>
            <div class="palette-item" onclick="setConnectionMode('satisfy')">
                ✅ 满足 (Satisfy)
            </div>
        </div>
        
        <!-- 中间画布 -->
        <div class="canvas-container" 
             ondrop="handleDrop(event)" 
             ondragover="handleDragOver(event)">
            <svg id="canvas" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" 
                            refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#34495e" />
                    </marker>
                </defs>
                <g id="connections"></g>
                <g id="elements"></g>
            </svg>
        </div>
        
        <!-- 右侧属性面板 -->
        <div class="properties">
            <h3>属性</h3>
            <div id="property-content">
                <p style="color: #999;">选择一个元素查看属性</p>
            </div>
        </div>
    </div>
    
    <div class="statusbar">
        <span id="status">就绪</span> | 
        <span id="element-count">元素: 0</span> | 
        <span id="connection-count">连接: 0</span>
    </div>
    
    <script>
        let elements = [];
        let connections = [];
        let selectedElement = null;
        let connectionMode = null;
        let connectionStart = null;
        let nextId = 1;
        
        // 拖拽处理
        document.querySelectorAll('.palette-item[draggable="true"]').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
        });
        
        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('elementType', e.target.dataset.type);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const type = e.dataTransfer.getData('elementType');
            const rect = document.getElementById('canvas').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            createSysMLElement(type, x, y);
        }
        
        // 创建SysML元素
        function createSysMLElement(type, x, y) {
            const id = `element-${nextId++}`;
            const element = {
                id: id,
                type: type,
                x: x,
                y: y,
                width: 150,
                height: 80,
                name: `${type.charAt(0).toUpperCase()}${type.slice(1)}_${nextId}`,
                properties: {}
            };
            
            elements.push(element);
            drawElement(element);
            updateStatus();
            
            // 保存到后端
            saveElementToBackend(element);
        }
        
        // 绘制元素
        function drawElement(element) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('id', element.id);
            g.setAttribute('class', 'sysml-element');
            g.setAttribute('transform', `translate(${element.x}, ${element.y})`);
            
            // 矩形背景
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', element.width);
            rect.setAttribute('height', element.height);
            rect.setAttribute('rx', '5');
            rect.setAttribute('fill', getElementColor(element.type));
            rect.setAttribute('stroke', '#333');
            rect.setAttribute('stroke-width', '2');
            
            // 文本标签
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', element.width / 2);
            text.setAttribute('y', element.height / 2);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.setAttribute('fill', 'white');
            text.setAttribute('font-size', '14');
            text.textContent = element.name;
            
            g.appendChild(rect);
            g.appendChild(text);
            
            // 添加交互
            g.addEventListener('mousedown', startDrag);
            g.addEventListener('click', selectElement);
            
            document.getElementById('elements').appendChild(g);
        }
        
        // 获取元素颜色
        function getElementColor(type) {
            const colors = {
                requirement: '#e74c3c',
                block: '#3498db',
                interface: '#f39c12',
                constraint: '#9b59b6'
            };
            return colors[type] || '#95a5a6';
        }
        
        // 拖动元素
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };
        
        function startDrag(e) {
            if (connectionMode) {
                // 连接模式
                handleConnectionStart(e);
                return;
            }
            
            dragElement = e.currentTarget;
            const rect = document.getElementById('canvas').getBoundingClientRect();
            const transform = dragElement.getAttribute('transform');
            const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
            
            if (match) {
                dragOffset.x = e.clientX - rect.left - parseFloat(match[1]);
                dragOffset.y = e.clientY - rect.top - parseFloat(match[2]);
            }
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function drag(e) {
            if (!dragElement) return;
            
            const rect = document.getElementById('canvas').getBoundingClientRect();
            const x = e.clientX - rect.left - dragOffset.x;
            const y = e.clientY - rect.top - dragOffset.y;
            
            dragElement.setAttribute('transform', `translate(${x}, ${y})`);
            
            // 更新元素数据
            const elementId = dragElement.id;
            const element = elements.find(el => el.id === elementId);
            if (element) {
                element.x = x;
                element.y = y;
                updateConnections();
            }
        }
        
        function stopDrag() {
            dragElement = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        // 选择元素
        function selectElement(e) {
            if (connectionMode && connectionStart) {
                // 完成连接
                handleConnectionEnd(e);
                return;
            }
            
            // 清除之前的选择
            document.querySelectorAll('.sysml-element').forEach(el => {
                el.classList.remove('selected');
            });
            
            // 选择当前元素
            e.currentTarget.classList.add('selected');
            selectedElement = elements.find(el => el.id === e.currentTarget.id);
            
            showProperties(selectedElement);
        }
        
        // 显示属性
        function showProperties(element) {
            const content = document.getElementById('property-content');
            
            if (!element) {
                content.innerHTML = '<p style="color: #999;">选择一个元素查看属性</p>';
                return;
            }
            
            content.innerHTML = `
                <div class="property-group">
                    <label>ID</label>
                    <input type="text" value="${element.id}" readonly>
                </div>
                <div class="property-group">
                    <label>名称</label>
                    <input type="text" value="${element.name}" onchange="updateElementName(this.value)">
                </div>
                <div class="property-group">
                    <label>类型</label>
                    <input type="text" value="${element.type}" readonly>
                </div>
                ${element.type === 'requirement' ? `
                <div class="property-group">
                    <label>需求文本</label>
                    <textarea onchange="updateElementProperty('text', this.value)">${element.properties.text || ''}</textarea>
                </div>
                <div class="property-group">
                    <label>优先级</label>
                    <select onchange="updateElementProperty('priority', this.value)">
                        <option value="LOW">低</option>
                        <option value="MEDIUM" selected>中</option>
                        <option value="HIGH">高</option>
                        <option value="CRITICAL">关键</option>
                    </select>
                </div>
                ` : ''}
            `;
        }
        
        // 更新元素名称
        function updateElementName(name) {
            if (!selectedElement) return;
            
            selectedElement.name = name;
            const text = document.querySelector(`#${selectedElement.id} text`);
            if (text) text.textContent = name;
        }
        
        // 更新元素属性
        function updateElementProperty(prop, value) {
            if (!selectedElement) return;
            selectedElement.properties[prop] = value;
        }
        
        // 连接模式
        function setConnectionMode(mode) {
            connectionMode = mode;
            connectionStart = null;
            document.getElementById('status').textContent = `连接模式: ${mode}`;
            document.getElementById('canvas').style.cursor = 'crosshair';
        }
        
        function handleConnectionStart(e) {
            connectionStart = e.currentTarget.id;
            document.getElementById('status').textContent = `选择目标元素...`;
        }
        
        function handleConnectionEnd(e) {
            const connectionEnd = e.currentTarget.id;
            
            if (connectionStart && connectionEnd && connectionStart !== connectionEnd) {
                createConnection(connectionStart, connectionEnd, connectionMode);
            }
            
            // 重置
            connectionMode = null;
            connectionStart = null;
            document.getElementById('canvas').style.cursor = 'default';
            document.getElementById('status').textContent = '就绪';
        }
        
        // 创建连接
        function createConnection(startId, endId, type) {
            const connection = {
                id: `connection-${connections.length + 1}`,
                start: startId,
                end: endId,
                type: type
            };
            
            connections.push(connection);
            drawConnection(connection);
            updateStatus();
            
            // 保存到后端
            saveConnectionToBackend(connection);
        }
        
        // 绘制连接
        function drawConnection(connection) {
            const startEl = elements.find(el => el.id === connection.start);
            const endEl = elements.find(el => el.id === connection.end);
            
            if (!startEl || !endEl) return;
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('id', connection.id);
            line.setAttribute('class', `connection-line ${connection.type}`);
            
            updateConnectionPath(line, startEl, endEl);
            
            document.getElementById('connections').appendChild(line);
        }
        
        // 更新连接路径
        function updateConnectionPath(line, startEl, endEl) {
            const x1 = startEl.x + startEl.width / 2;
            const y1 = startEl.y + startEl.height;
            const x2 = endEl.x + endEl.width / 2;
            const y2 = endEl.y;
            
            const path = `M ${x1} ${y1} L ${x2} ${y2}`;
            line.setAttribute('d', path);
        }
        
        // 更新所有连接
        function updateConnections() {
            connections.forEach(conn => {
                const line = document.getElementById(conn.id);
                const startEl = elements.find(el => el.id === conn.start);
                const endEl = elements.find(el => el.id === conn.end);
                
                if (line && startEl && endEl) {
                    updateConnectionPath(line, startEl, endEl);
                }
            });
        }
        
        // 更新状态栏
        function updateStatus() {
            document.getElementById('element-count').textContent = `元素: ${elements.length}`;
            document.getElementById('connection-count').textContent = `连接: ${connections.length}`;
        }
        
        // 保存元素到后端
        async function saveElementToBackend(element) {
            if (element.type === 'requirement') {
                const mutation = `
                    mutation {
                        createRequirement(input: {
                            reqId: "${element.id}"
                            name: "${element.name}"
                            text: "${element.properties.text || ''}"
                            kind: FUNCTIONAL
                            priority: ${element.properties.priority || 'MEDIUM'}
                        }) {
                            ok
                            requirement { id }
                        }
                    }
                `;
                
                try {
                    const response = await fetch('/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: mutation })
                    });
                    const data = await response.json();
                    if (data.data.createRequirement.ok) {
                        element.backendId = data.data.createRequirement.requirement.id;
                    }
                } catch (error) {
                    console.error('保存失败:', error);
                }
            }
        }
        
        // 保存连接到后端
        async function saveConnectionToBackend(connection) {
            const startEl = elements.find(el => el.id === connection.start);
            const endEl = elements.find(el => el.id === connection.end);
            
            if (startEl?.backendId && endEl?.backendId && connection.type === 'derive') {
                const mutation = `
                    mutation {
                        deriveRequirement(
                            sourceId: "${startEl.backendId}"
                            targetId: "${endEl.backendId}"
                        ) {
                            ok
                        }
                    }
                `;
                
                try {
                    await fetch('/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: mutation })
                    });
                } catch (error) {
                    console.error('保存连接失败:', error);
                }
            }
        }
        
        // 工具栏功能
        function saveModel() {
            const model = { elements, connections };
            const json = JSON.stringify(model, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sysml-model.json';
            a.click();
        }
        
        function loadModel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const model = JSON.parse(event.target.result);
                    elements = model.elements || [];
                    connections = model.connections || [];
                    redrawCanvas();
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function clearCanvas() {
            if (confirm('确定要清空画布吗？')) {
                elements = [];
                connections = [];
                document.getElementById('elements').innerHTML = '';
                document.getElementById('connections').innerHTML = '';
                updateStatus();
            }
        }
        
        function exportSVG() {
            const svg = document.getElementById('canvas').cloneNode(true);
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sysml-diagram.svg';
            a.click();
        }
        
        function autoLayout() {
            // 简单的自动布局算法
            const cols = Math.ceil(Math.sqrt(elements.length));
            const spacing = 200;
            const startX = 50;
            const startY = 50;
            
            elements.forEach((element, index) => {
                const row = Math.floor(index / cols);
                const col = index % cols;
                element.x = startX + col * spacing;
                element.y = startY + row * spacing;
            });
            
            redrawCanvas();
        }
        
        function redrawCanvas() {
            document.getElementById('elements').innerHTML = '';
            document.getElementById('connections').innerHTML = '';
            
            elements.forEach(element => drawElement(element));
            connections.forEach(connection => drawConnection(connection));
            updateStatus();
        }
    </script>
</body>
</html>